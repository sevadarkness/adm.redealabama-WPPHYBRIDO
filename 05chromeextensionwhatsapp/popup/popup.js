/**
 * ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
 * ‚ïë                                                                           ‚ïë
 * ‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó            ‚ïë
 * ‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó           ‚ïë
 * ‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë           ‚ïë
 * ‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù      ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë           ‚ïë
 * ‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë           ‚ïë
 * ‚ïë   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù           ‚ïë
 * ‚ïë                                                                           ‚ïë
 * ‚ïë                    SISTEMA PROPRIET√ÅRIO                                   ‚ïë
 * ‚ïë                                                                           ‚ïë
 * ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
 * ‚ïë                                                                           ‚ïë
 * ‚ïë   ¬© 2024 Rede Alabama. Todos os direitos reservados.                      ‚ïë
 * ‚ïë                                                                           ‚ïë
 * ‚ïë   Este software √© propriedade exclusiva da Rede Alabama.                  ‚ïë
 * ‚ïë   A c√≥pia, distribui√ß√£o ou uso n√£o autorizado √© PROIBIDO                  ‚ïë
 * ‚ïë   e sujeito a penalidades legais conforme Lei 9.609/98.                   ‚ïë
 * ‚ïë                                                                           ‚ïë
 * ‚ïë   Fingerprint: RA-2024-WPPHYBRIDO-ALABAMA                                 ‚ïë
 * ‚ïë                                                                           ‚ïë
 * ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
 */

const el = (id) => document.getElementById(id);

// Global state
let quickReplies = [];
let teamMembers = [];

async function send(type, payload) {
  return new Promise((resolve) => {
    try {
      chrome.runtime.sendMessage({ type, ...(payload || {}) }, (resp) => {
        const err = chrome.runtime.lastError;
        if (err) return resolve({ ok: false, error: err.message || String(err) });
        resolve(resp);
      });
    } catch (e) {
      resolve({ ok: false, error: e?.message || String(e) });
    }
  });
}

function setStatus(msg, ok = true) {
  const s = el("status");
  s.textContent = msg || "";
  s.className = "status " + (ok ? "ok" : "err");
}

// -------------------------
// Tab Navigation
// -------------------------
document.querySelectorAll('.popup-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    // Remover active de todas as abas
    document.querySelectorAll('.popup-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.popup-tab-content').forEach(c => c.classList.remove('active'));
    
    // Ativar aba clicada
    tab.classList.add('active');
    const tabId = `tab-${tab.dataset.tab}`;
    document.getElementById(tabId).classList.add('active');
  });
});

// -------------------------
// Load Settings
// -------------------------
async function load() {
  const resp = await send("GET_SETTINGS", {});
  if (!resp?.ok) throw new Error(resp?.error || "Falha ao carregar settings.");

  const st = resp?.settings || {};

  // Chatbot
  el("persona").value = st.persona || "";
  el("businessContext").value = st.businessContext || "";
  el("autoSuggest").checked = Boolean(st.autoSuggest);
  el("autoMemory").checked = Boolean(st.autoMemory);

  // Quick Replies
  quickReplies = st.quickReplies || [];
  renderQuickReplies(quickReplies);

  // Team
  el("senderName").value = st.senderName || "";
  teamMembers = st.teamMembers || [];
  renderTeamMembers(teamMembers);
  
  // Load copilot data
  await loadCopilotData();
}

// -------------------------
// Save Settings
// -------------------------
async function saveSettings() {
  setStatus("Salvando‚Ä¶", true);

  const settings = {
    // Chatbot
    persona: el("persona").value,
    businessContext: el("businessContext").value,
    autoSuggest: el("autoSuggest").checked,
    autoMemory: el("autoMemory").checked,
    
    // Quick Replies
    quickReplies: quickReplies,
    
    // Team
    senderName: el("senderName").value,
    teamMembers: teamMembers,
  };

  const resp = await send("SAVE_SETTINGS", { settings });
  if (resp?.ok) setStatus("Salvo ‚úÖ", true);
  else setStatus(resp?.error || "Falha ao salvar", false);
}

el("save").addEventListener("click", saveSettings);

// -------------------------
// Copilot Mode Functions
// -------------------------
async function loadCopilotData() {
  try {
    const resp = await send("GET_CONFIDENCE", {});
    if (!resp?.ok) {
      console.error("Failed to load copilot data:", resp?.error);
      return;
    }
    
    const { score, level, metrics, config, points_to_threshold } = resp;
    
    // Update confidence bar and percentage
    el("confidencePercent").textContent = `${Math.round(score)}%`;
    const fillEl = el("confidenceFill");
    fillEl.style.width = `${score}%`;
    fillEl.setAttribute("data-level", level.level);
    
    // Update confidence level
    el("confidenceLevel").innerHTML = `
      <span class="level-emoji">${level.emoji}</span>
      <span class="level-label">${level.label}</span>
      <span class="level-desc">${level.description}</span>
    `;
    
    // Update threshold indicator
    el("confidenceThreshold").style.left = `${config.copilot_threshold}%`;
    
    // Update copilot controls
    el("copilotEnabled").checked = config.copilot_enabled;
    el("copilotEnabled").disabled = score < config.copilot_threshold;
    el("copilotStatusText").textContent = config.copilot_enabled 
      ? "Modo Copiloto Ativo" 
      : "Modo Copiloto Desativado";
    
    el("copilotThreshold").value = config.copilot_threshold;
    el("thresholdValue").textContent = `${config.copilot_threshold}%`;
    
    // Update stats
    el("statGood").textContent = metrics.total_good;
    el("statBad").textContent = metrics.total_bad;
    el("statCorrections").textContent = metrics.total_corrections;
    el("statAutoSent").textContent = metrics.total_auto_sent;
    
    // Update goal
    const goalEl = el("copilotGoal");
    if (score >= config.copilot_threshold) {
      goalEl.innerHTML = "üéâ <strong>Meta Atingida!</strong> Modo Copiloto dispon√≠vel";
      goalEl.classList.add("achieved");
    } else {
      goalEl.innerHTML = `üéØ <strong>Faltam <span id="pointsToGoal">${Math.round(points_to_threshold)}</span> pontos</strong> para o Modo Copiloto`;
      goalEl.classList.remove("achieved");
    }
  } catch (e) {
    console.error("Error loading copilot data:", e);
  }
}

el("copilotEnabled").addEventListener("change", async (e) => {
  const enabled = e.target.checked;
  const resp = await send("TOGGLE_COPILOT", { enabled });
  if (resp?.ok) {
    el("copilotStatusText").textContent = enabled 
      ? "Modo Copiloto Ativo" 
      : "Modo Copiloto Desativado";
  } else {
    e.target.checked = !enabled;
  }
});

el("copilotThreshold").addEventListener("input", (e) => {
  el("thresholdValue").textContent = `${e.target.value}%`;
});

el("copilotThreshold").addEventListener("change", async (e) => {
  const threshold = Number(e.target.value);
  const resp = await send("SET_THRESHOLD", { threshold });
  if (resp?.ok) {
    el("confidenceThreshold").style.left = `${threshold}%`;
    await loadCopilotData();
  }
});

// -------------------------
// Quick Replies Functions
// -------------------------
function addQuickReply() {
  const trigger = el("qrTrigger").value.trim().toLowerCase();
  const response = el("qrResponse").value.trim();
  
  if (!trigger || !response) {
    setStatus("Preencha gatilho e resposta", false);
    return;
  }
  
  const newReply = {
    id: `qr_${Date.now()}`,
    trigger,
    response,
    createdAt: new Date().toISOString()
  };
  
  quickReplies.push(newReply);
  renderQuickReplies(quickReplies);
  saveSettings();
  
  // Limpar form
  el("qrTrigger").value = "";
  el("qrResponse").value = "";
  setStatus("Mensagem r√°pida adicionada ‚úÖ", true);
}

function removeQuickReply(id) {
  quickReplies = quickReplies.filter(qr => qr.id !== id);
  renderQuickReplies(quickReplies);
  saveSettings();
  setStatus("Mensagem r√°pida removida", true);
}

function renderQuickReplies(replies) {
  const container = el("quickReplyList");
  if (!replies.length) {
    container.innerHTML = '<p class="empty-state">Nenhuma mensagem r√°pida cadastrada</p>';
    return;
  }
  
  container.innerHTML = replies.map(qr => `
    <div class="quick-reply-item" data-id="${qr.id}">
      <div class="qr-trigger">/${qr.trigger}</div>
      <div class="qr-response">${escapeHtml(qr.response)}</div>
      <button class="btn-delete" data-id="${qr.id}">üóëÔ∏è</button>
    </div>
  `).join('');
  
  // Add event listeners for delete buttons
  container.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = e.target.dataset.id;
      removeQuickReply(id);
    });
  });
}

el("addQuickReply").addEventListener("click", addQuickReply);

// -------------------------
// Team Functions
// -------------------------
function addTeamMember() {
  const name = el("memberName").value.trim();
  const phone = el("memberPhone").value.trim().replace(/\D/g, '');
  
  if (!name || !phone) {
    setStatus("Preencha nome e n√∫mero", false);
    return;
  }
  
  if (phone.length < 10) {
    setStatus("N√∫mero inv√°lido (m√≠nimo 10 d√≠gitos)", false);
    return;
  }
  
  const newMember = {
    id: `tm_${Date.now()}`,
    name,
    phone,
    selected: false,
    createdAt: new Date().toISOString()
  };
  
  teamMembers.push(newMember);
  renderTeamMembers(teamMembers);
  saveSettings();
  
  // Limpar form
  el("memberName").value = "";
  el("memberPhone").value = "";
  setStatus("Membro adicionado ‚úÖ", true);
}

function removeTeamMember(id) {
  teamMembers = teamMembers.filter(m => m.id !== id);
  renderTeamMembers(teamMembers);
  saveSettings();
  setStatus("Membro removido", true);
}

function toggleMemberSelection(id) {
  const member = teamMembers.find(m => m.id === id);
  if (member) {
    member.selected = !member.selected;
    renderTeamMembers(teamMembers);
    updateMessagePreview();
  }
}

function selectAllMembers() {
  teamMembers.forEach(m => m.selected = true);
  renderTeamMembers(teamMembers);
  updateMessagePreview();
}

function clearSelection() {
  teamMembers.forEach(m => m.selected = false);
  renderTeamMembers(teamMembers);
  updateMessagePreview();
}

function renderTeamMembers(members) {
  const container = el("teamMembersContainer");
  if (!members.length) {
    container.innerHTML = '<p class="empty-state">Nenhum membro cadastrado</p>';
    return;
  }
  
  container.innerHTML = members.map(m => `
    <div class="team-member-item ${m.selected ? 'selected' : ''}" data-id="${m.id}">
      <label class="checkbox-container">
        <input type="checkbox" ${m.selected ? 'checked' : ''} data-id="${m.id}">
      </label>
      <div class="member-info">
        <span class="member-name">${escapeHtml(m.name)}</span>
        <span class="member-phone">${formatPhone(m.phone)}</span>
      </div>
      <button class="btn-delete" data-id="${m.id}">üóëÔ∏è</button>
    </div>
  `).join('');
  
  // Add event listeners
  container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', (e) => {
      toggleMemberSelection(e.target.dataset.id);
    });
  });
  
  container.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', (e) => {
      removeTeamMember(e.target.dataset.id);
    });
  });
  
  updateMessagePreview();
}

function formatPhone(phone) {
  if (phone.length === 13) {
    return phone.replace(/(\d{2})(\d{2})(\d{5})(\d{4})/, '+$1 ($2) $3-$4');
  } else if (phone.length === 11) {
    return phone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
  }
  return phone;
}

function updateMessagePreview() {
  const senderName = el("senderName").value || "Empresa";
  const message = el("teamMessage").value || "Sua mensagem aqui...";
  const selectedCount = teamMembers.filter(m => m.selected).length;
  
  el("teamMessagePreview").innerHTML = `
    üì± <strong>Preview da notifica√ß√£o:</strong><br>
    "<strong>${escapeHtml(senderName)}:</strong> ${escapeHtml(message.substring(0, 50))}${message.length > 50 ? '...' : ''}"<br>
    <small>${selectedCount} membro(s) selecionado(s)</small>
  `;
}

async function sendToTeam() {
  const senderName = el("senderName").value.trim();
  const message = el("teamMessage").value.trim();
  const selectedMembers = teamMembers.filter(m => m.selected);
  
  if (!message) {
    setStatus("Digite uma mensagem", false);
    return;
  }
  
  if (!selectedMembers.length) {
    setStatus("Selecione pelo menos um membro", false);
    return;
  }
  
  // Formatar mensagem com nome do remetente
  const fullMessage = senderName ? `*${senderName}:* ${message}` : message;
  
  setStatus(`Enviando para ${selectedMembers.length} membro(s)...`, true);
  
  try {
    const response = await send("SEND_TO_TEAM", {
      payload: {
        members: selectedMembers,
        message: fullMessage,
        senderName
      }
    });
    
    if (response.ok) {
      setStatus(`‚úÖ Enviado para ${selectedMembers.length} membro(s)!`, true);
      el("teamMessage").value = "";
      clearSelection();
      updateMessagePreview();
    } else {
      setStatus(`‚ùå Erro: ${response.error}`, false);
    }
  } catch (e) {
    setStatus(`‚ùå Erro: ${e.message}`, false);
  }
}

// Team event listeners
el("addMember").addEventListener("click", addTeamMember);
el("selectAllMembers").addEventListener("click", selectAllMembers);
el("clearSelection").addEventListener("click", clearSelection);
el("sendToTeam").addEventListener("click", sendToTeam);
el("senderName").addEventListener("input", updateMessagePreview);
el("teamMessage").addEventListener("input", updateMessagePreview);

// -------------------------
// Utility Functions
// -------------------------
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// -------------------------
// Initialize
// -------------------------
load().catch((e) => setStatus(String(e?.message || e), false));
